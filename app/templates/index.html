<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto 2 - Simulador de Riego Robótico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container main-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class=flashes>
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <h1>Simulador de Riego Robótico</h1>
        <p class="text-center">Proyecto 2 - IPC2</p>
        
        <div class="text-center mb-4">
            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#helpModal">
              Ver Página de Ayuda
            </button>
        </div>

        <section id="upload-section">
            <h2>1. Cargar Configuración</h2>
            <form action="/cargar" method="post" enctype="multipart/form-data" class="mt-3">
                <div class="mb-3">
                    <input class="form-control" type="file" name="archivo_xml" accept=".xml" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Cargar y Procesar</button>
            </form>
        </section>

        {% if invernaderos %}
        <hr>
        <section id="simulation-section">
            <h2>2. Seleccionar y Simular</h2>
            <form action="/" method="post" class="mt-3">
                <div class="mb-3">
                    <label for="invernadero_select" class="form-label">Selecciona un Invernadero:</label>
                    <select name="invernadero" id="invernadero_select" class="form-select" required>
                        {% for invernadero in invernaderos %}
                            <option value="{{ invernadero.nombre }}">{{ invernadero.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="plan_riego_select" class="form-label">Selecciona un Plan de Riego:</label>
                    <select name="plan_riego" id="plan_riego_select" class="form-select" required></select>
                </div>
                <button type="submit" class="btn btn-primary w-100">Iniciar Simulación</button>
            </form>
        </section>
        {% endif %}

        {% if resultados %}
        <hr>
        <section id="results-section">
            <h2>3. Resultados de la Simulación</h2>
            <div class="results-container">
                <div class="summary-stats">
                    <p><strong>Invernadero:</strong> {{ resultados.nombre_invernadero }}</p>
                    <p><strong>Plan de Riego:</strong> {{ resultados.nombre_plan }}</p>
                    <p><strong>Tiempo Óptimo:</strong> {{ resultados.tiempo_optimo }} segundos</p>
                </div>

                <h3>Instrucciones por Segundo</h3>
                <table class="table table-bordered text-center">
                    <thead>
                        <tr>
                            <th>Tiempo (s)</th>
                            {% for dron_stat in resultados.eficiencia_drones %}
                                <th>{{ dron_stat.nombre }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for instruccion_segundo in resultados.instrucciones %}
                        <tr>
                            <td>{{ instruccion_segundo.segundo }}</td>
                            {% for dron_stat in resultados.eficiencia_drones %}
                                {% set accion_encontrada = namespace(valor='Fin') %}
                                {% for accion_dron in instruccion_segundo.acciones %}
                                    {% if accion_dron.nombre == dron_stat.nombre %}
                                        {% set accion_encontrada.valor = accion_dron.accion %}
                                    {% endif %}
                                {% endfor %}
                                <td class="{% set accion = accion_encontrada.valor %}{% if 'Regar' in accion %}action-regar{% elif 'Esperar' in accion %}action-esperar{% elif 'Fin' in accion %}action-fin{% else %}action-movimiento{% endif %}">{{ accion }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h3 class="mt-4">Estadísticas Finales por Dron</h3>
                <table class="table table-bordered text-center">
                    <thead>
                        <tr><th>Dron</th><th>Agua Consumida (L)</th><th>Fertilizante Consumido (g)</th></tr>
                    </thead>
                    <tbody>
                        {% for dron_stat in resultados.eficiencia_drones %}
                        <tr>
                            <td>{{ dron_stat.nombre }}</td>
                            <td>{{ dron_stat.litrosAgua }} L</td>
                            <td>{{ dron_stat.gramosFertilizante }} g</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <hr>
                
                <h4>Generar Reporte de TDA (en un tiempo 't')</h4>
                <form action="/generar-grafo" method="post" class="mt-3">
                    <input type="hidden" name="nombre_invernadero" value="{{ resultados.nombre_invernadero }}">
                    <input type="hidden" name="nombre_plan" value="{{ resultados.nombre_plan }}">
                    <div class="mb-3">
                        <label for="tiempo_t" class="form-label"><strong>Introduce el tiempo (segundos):</strong></label>
                        <input type="number" name="tiempo_t" id="tiempo_t" class="form-control" min="0" max="{{ resultados.tiempo_optimo }}" value="{{ tiempo_solicitado or 0 }}" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Generar Gráfico en t</button>
                </form>

                {% if grafo_path %}
                <div class="mt-4 text-center">
                    <h4>Estado de la Cola de Tareas en t={{ tiempo_solicitado }}s:</h4>
                    <img src="{{ grafo_path }}?v={{ range(10000) | random }}" alt="Grafo del estado de la Cola" class="img-fluid border p-2">
                </div>
                {% endif %}
            </div>
        </section>
        {% endif %}

        {% if invernaderos %}
        <hr>
        <section id="download-section">
            <h2>4. Generar Reportes Globales</h2>
            <form action="/generar-salida" method="post" class="mt-3">
                <p>Descarga un archivo <code>salida.xml</code> con la simulación de todos los planes de todos los invernaderos.</p>
                <button type="submit" class="btn btn-primary w-100">Descargar Archivo de Salida (salida.xml)</button>
            </form>
            <form action="/reporte-general" method="get" class="mt-3">
                <button type="submit" class="btn btn-secondary w-100">Ver Reporte HTML General</button>
            </form>
        </section>
        {% endif %}
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="helpModalLabel">Página de Ayuda</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h3>Información del Estudiante</h3>
            <p><strong>Nombre:</strong> Mario Rodrigo Balam Churunel</p>
            <p><strong>Carnet:</strong> 202200147</p>
            <p><strong>Curso:</strong> Introducción a la Programación y Computación 2</p>
            <hr>
            <h3>Acerca de la Aplicación</h3>
            <p>Esta aplicación es un simulador de un sistema de riego y fertilización robótico. Permite cargar configuraciones de invernaderos desde un archivo XML, simular planes de riego y analizar los resultados, incluyendo el tiempo óptimo y el consumo de recursos.</p>
            <hr>
            <h3>Documentación del Proyecto</h3>
            <p>Para un análisis técnico detallado, por favor consulte el ensayo y los diagramas entregados junto con el proyecto.</p>
            <p class="mt-3">
            <a href="https://github.com/BM200/IPC2_Proyecto2_202200147.git" target="_blank" class="btn btn-dark">
                <i class="bi bi-github"></i> Ver en GitHub
            </a>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const planesData = JSON.parse('{{ planes_data_json | safe }}');
        const invernaderoSelect = document.getElementById('invernadero_select');
        const planSelect = document.getElementById('plan_riego_select');
        function actualizarPlanes() {
            const invernaderoSeleccionado = invernaderoSelect.value;
            const planesDisponibles = planesData[invernaderoSeleccionado] || [];
            planSelect.innerHTML = '';
            planesDisponibles.forEach(nombrePlan => {
                const option = document.createElement('option');
                option.value = nombrePlan;
                option.textContent = nombrePlan;
                planSelect.appendChild(option);
            });
        }
        if (invernaderoSelect) {
            actualizarPlanes();
            invernaderoSelect.addEventListener('change', actualizarPlanes);
        }
    </script>
</body>
</html>