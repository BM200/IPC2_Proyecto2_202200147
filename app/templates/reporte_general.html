<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte General de Simulaciones</title>
    
    <!-- Enlace a Bootstrap CSS para un estilo base consistente -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Enlace a nuestro CSS externo personalizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Estilos adicionales específicos para esta página de reporte -->
    <style>
        .main-container {
            max-width: 1200px; /* Hacemos el contenedor más ancho para las tablas */
        }
        .invernadero-section {
            margin-bottom: 50px;
            padding: 20px;
            border: 1px solid var(--color-borde);
            border-radius: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stat-box {
            background-color: #F9F9F9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--color-borde);
        }
        .stat-box .label {
            font-weight: bold;
            display: block;
        }
        .stat-box .value {
            font-size: 1.5em;
            color: var(--color-verde-principal);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <h1>Reporte General de Simulaciones</h1>
        <p class="text-center">Resultados detallados para cada plan de riego en cada invernadero.</p>
        <a href="/" class="btn btn-secondary back-link">Volver a Simulación</a>

        <!-- Agrupamos los resultados por el nombre del invernadero usando un filtro de Jinja2 -->
        {% set resultados_agrupados = lista_resultados|groupby('nombre_invernadero') %}
        
        {% for nombre_invernadero, planes in resultados_agrupados %}
        <section class="invernadero-section">
            <h2>Invernadero: {{ nombre_invernadero }}</h2>

            {% for resultados in planes %}
            <div class="plan-section mt-4">
                <h3 class="bg-light p-2 rounded border-start border-primary border-5">{{ resultados.nombre_plan }}</h3>

                <!-- Estadísticas Resumidas del Plan -->
                <div class="stats-grid mt-3">
                    <div class="stat-box">
                        <span class="label">Tiempo Óptimo</span>
                        <span class="value">{{ resultados.tiempo_optimo }} s</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">Agua Total</span>
                        <span class="value">{{ resultados.agua_requerida }} L</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">Fertilizante Total</span>
                        <span class="value">{{ resultados.fertilizante_requerido }} g</span>
                    </div>
                </div>

                <!-- Tabla de Eficiencia de Drones -->
                <h4 class="mt-4">Estadísticas por Dron</h4>
                <table class="table table-bordered text-center">
                    <thead>
                        <tr><th>Dron</th><th>Agua Consumida (L)</th><th>Fertilizante Consumido (g)</th></tr>
                    </thead>
                    <tbody>
                        {% for dron_stat in resultados.eficiencia_drones %}
                        <tr>
                            <td>{{ dron_stat.nombre }}</td>
                            <td>{{ dron_stat.litrosAgua }} L</td>
                            <td>{{ dron_stat.gramosFertilizante }} g</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Tabla de Instrucciones por Segundo -->
                <h4 class="mt-4">Instrucciones por Segundo</h4>
                <table class="table table-bordered text-center">
                    <thead>
                        <tr>
                            <th>Tiempo (s)</th>
                            {% for dron_stat in resultados.eficiencia_drones %}
                                <th>{{ dron_stat.nombre }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for instruccion_segundo in resultados.instrucciones %}
                        <tr>
                            <td>{{ instruccion_segundo.segundo }}</td>
                            {% for dron_stat in resultados.eficiencia_drones %}
                                {% set accion_encontrada = namespace(valor='Fin') %}
                                {% for accion_dron in instruccion_segundo.acciones %}
                                    {% if accion_dron.nombre == dron_stat.nombre %}
                                        {% set accion_encontrada.valor = accion_dron.accion %}
                                    {% endif %}
                                {% endfor %}
                                <td class="{% set accion = accion_encontrada.valor %}{% if 'Regar' in accion %}action-regar{% elif 'Esperar' in accion %}action-esperar{% elif 'Fin' in accion %}action-fin{% else %}action-movimiento{% endif %}">{{ accion }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Separador entre planes de un mismo invernadero -->
            {% if not loop.last %}
                <hr>
            {% endif %}
            {% endfor %}
        </section>
        {% endfor %}
        
        <a href="/" class="btn btn-secondary back-link">Volver a Simulación</a>
    </div>
</body>
</html>